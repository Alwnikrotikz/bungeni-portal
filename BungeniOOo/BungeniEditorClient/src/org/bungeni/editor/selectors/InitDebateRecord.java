/*
 * InitDebateRecord.java
 *
 * Created on August 27, 2007, 11:39 AM
 */

package org.bungeni.editor.selectors;

import com.sun.star.text.XText;
import com.sun.star.text.XTextContent;
import com.sun.star.text.XTextCursor;
import com.sun.star.text.XTextViewCursor;
import java.awt.Container;
import java.io.File;
import java.text.DateFormat;
import java.text.Format;
import java.text.SimpleDateFormat;
import java.util.Date;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JRootPane;
import javax.swing.text.DateFormatter;
import javax.swing.text.DefaultFormatterFactory;
import org.bungeni.db.DefaultInstanceFactory;
import org.bungeni.editor.actions.toolbarAction;
import org.bungeni.editor.BungeniEditorProperties;
import org.bungeni.editor.dialogs.*;
import org.bungeni.editor.fragments.FragmentsFactory;
import org.bungeni.editor.macro.ExternalMacro;
import org.bungeni.editor.macro.ExternalMacroFactory;
import org.bungeni.ooo.OOComponentHelper;
import org.bungeni.utils.MessageBox;

/**
 *
 * @author  Administrator
 * This class creates the initial MastHead section
 * - creates text section with specific name
 * - allows setting various variables within that section
 * - slaps the text into the created text section
 */
public class InitDebateRecord extends javax.swing.JPanel implements IDialogSelector{
    private OOComponentHelper ooDocument;
    private JDialog parent;
    private toolbarAction theAction;
    private SelectorDialogModes theMode;
   private static org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(InitDebateRecord.class.getName());
     
   private String m_strLogoPath; 
   private String m_strLogoFileName;
    /** Creates new form InitDebateRecord */
    public InitDebateRecord() {
        initComponents();
    }
    
    public InitDebateRecord(OOComponentHelper ooDocument, 
            JDialog parentDlg, 
            toolbarAction theAction) {
        this.ooDocument = ooDocument;
        this.parent = parentDlg;
        this.theAction = theAction;
        initComponents();
        //default m_strLogoPath
        String logoPath = BungeniEditorProperties.getEditorProperty("logoPath");
        log.debug("logo path = " + logoPath);
        String strPath = DefaultInstanceFactory.DEFAULT_INSTALLATION_PATH();
        m_strLogoPath = strPath + File.separator + logoPath + File.separator + "default_logo.jpg";
        log.debug("InitDebateRecord:" + m_strLogoPath);
        // DateFormat formatter = new SimpleDateFormat("H:m"); 
       // DateFormatter dfTimeOfHansard = new DateFormatter(formatter);
       // initdebate_timeofhansard.setFormatterFactory(new DefaultFormatterFactory(dfTimeOfHansard));
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents() {
        initdebate_debatedate = new org.jdesktop.swingx.JXDatePicker();
        lbl_initdebate_hansarddate = new javax.swing.JLabel();
        lbl_initdate_mastheadlogo = new javax.swing.JLabel();
        btn_initdebate_selectlogo = new javax.swing.JButton();
        lbl_initdebate_hansardtime = new javax.swing.JLabel();
        btnApply = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();
        lbl_initdebate_setpath = new javax.swing.JLabel();
        initdebate_timeofhansard = new javax.swing.JFormattedTextField();

        lbl_initdebate_hansarddate.setText("Hansard Date");

        lbl_initdate_mastheadlogo.setText("Masthead Logo");

        btn_initdebate_selectlogo.setText("Select Logo...");
        btn_initdebate_selectlogo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_initdebate_selectlogoActionPerformed(evt);
            }
        });

        lbl_initdebate_hansardtime.setText("Hansard Time");

        btnApply.setText("Apply to Document ");
        btnApply.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnApplyActionPerformed(evt);
            }
        });

        btnCancel.setText("Cancel");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(layout.createSequentialGroup()
                        .add(lbl_initdebate_setpath, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 279, Short.MAX_VALUE)
                        .addContainerGap())
                    .add(lbl_initdebate_hansarddate, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 289, Short.MAX_VALUE)
                    .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, btn_initdebate_selectlogo, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 133, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, lbl_initdate_mastheadlogo, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 163, Short.MAX_VALUE)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, lbl_initdebate_hansardtime, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 163, Short.MAX_VALUE)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, btnApply, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 138, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(btnCancel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 112, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                        .addContainerGap())
                    .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, initdebate_timeofhansard, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 279, Short.MAX_VALUE)
                            .add(initdebate_debatedate, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 279, Short.MAX_VALUE))
                        .addContainerGap())))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .add(36, 36, 36)
                .add(lbl_initdebate_hansarddate)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(initdebate_debatedate, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(lbl_initdebate_hansardtime)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(initdebate_timeofhansard, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .add(4, 4, 4)
                .add(lbl_initdate_mastheadlogo)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(btn_initdebate_selectlogo)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(lbl_initdebate_setpath, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 14, Short.MAX_VALUE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(btnApply)
                    .add(btnCancel))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

   
    private void enableButtons(boolean state) {
        btnApply.setEnabled(state);
        btnCancel.setEnabled(state);
    }
    private void btnApplyActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnApplyActionPerformed
// TODO add your handling code here:
        //get field values : 
    enableButtons(false);    
    
    String strDebateDate = "", strTimeOfHansard = "", strLogoPath = "";   
    Date dtDebate = initdebate_debatedate.getDate();
    strTimeOfHansard =  initdebate_timeofhansard.getText();
    SimpleDateFormat formatter = new SimpleDateFormat ("MMMM dd yyyy");
    strDebateDate = formatter.format(dtDebate);
    strLogoPath = m_strLogoPath;
    //do checks 
    if (!ooDocument.hasSection("root")){
        MessageBox.OK(parent, "The document does not have a root section, and cannot be used!" );
        enableButtons(true);
        return;
    }
    
    if (ooDocument.hasSection(theAction.action_naming_convention())) {
        MessageBox.OK(parent, "This document already has a mast head, you cannot add a second one!");
        enableButtons(true);
        return;
    }
    
    //adding section
   if (theAction.action_type().equals("section")) {
        //create a text section
        //add section inside section
        //rem 254 is = .1 inch
        //rem 508 is = .2 inch
        long sectionBackColor = 0xe6e6e6;
        float sectionLeftMargin = (float).2;
        log.debug("section left margin : "+ sectionLeftMargin);
        ExternalMacro AddSectionInsideSection = ExternalMacroFactory.getMacroDefinition("AddSectionInsideSectionWithStyle");
        AddSectionInsideSection.addParameter("root");
        AddSectionInsideSection.addParameter(theAction.action_naming_convention());
        AddSectionInsideSection.addParameter(sectionBackColor);
        AddSectionInsideSection.addParameter(sectionLeftMargin);
        
        ooDocument.executeMacro(AddSectionInsideSection.toString(), AddSectionInsideSection.getParams());
      
        //load the related document
        //set the field values in loaded document
        /*
           String sectionClass = "com.sun.star.text.TextSection";
           XTextViewCursor xCursor = ooDocument.getViewCursor();
           XText xText = xCursor.getText();
           XTextContent xSectionContent = ooDocument.createTextSection(theAction.action_naming_convention(), (short)1);
            try {
             xText.insertTextContent(xCursor, xSectionContent , true);
            } catch (com.sun.star.lang.IllegalArgumentException ex) {
                btnApply.setEnabled(true);
            log.debug("in addTextSection : "+ex.getLocalizedMessage(), ex);
            } 
          */ 
            //embed logo image
             ExternalMacro addImageIntoSection = ExternalMacroFactory.getMacroDefinition("AddImageIntoSection");
             addImageIntoSection.addParameter(theAction.action_naming_convention());
             addImageIntoSection.addParameter(m_strLogoPath);
             ooDocument.executeMacro(addImageIntoSection.toString(), addImageIntoSection.getParams());
            
            //loading the related document
            ExternalMacro insertDocIntoSection = ExternalMacroFactory.getMacroDefinition("InsertDocumentIntoSection");
            insertDocIntoSection.addParameter(theAction.action_naming_convention())   ;
            insertDocIntoSection.addParameter(FragmentsFactory.getFragment("hansard_masthead"));
            ooDocument.executeMacro(insertDocIntoSection.toString(), insertDocIntoSection.getParams());
            
            //set values from loaded document
            ExternalMacro setFieldValue = ExternalMacroFactory.getMacroDefinition("SetInputFieldValue");
            setFieldValue.addParameter(new String("debaterecord_official_date"));
            setFieldValue.addParameter(strDebateDate);
            ooDocument.executeMacro( setFieldValue.toString(),  setFieldValue.getParams());
   
            setFieldValue.clearParams();
            setFieldValue.addParameter(new String("debaterecord_official_time"));
            setFieldValue.addParameter(strTimeOfHansard);
            ooDocument.executeMacro( setFieldValue.toString(),  setFieldValue.getParams());
           
   }       
   enableButtons(true);
   MessageBox.OK(parent, "Prayers section was successfully added");
    //ooDocument.executeDispatch("")
        //added Section, now execute Macros
        //load template document into main document
    /*
 
      
      ExternalMacro addTextToSection = ExternalMacroFactory.getMacroDefinition("AddTextToSection");
      addTextToSection.addParameter(new String("prayers"));
      addTextToSection.addParameter(new String ("National Assembly"));
      addTextToSection.addParameter(new String("Heading 1"));
    */
   
      
    }//GEN-LAST:event_btnApplyActionPerformed

    private void btn_initdebate_selectlogoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btn_initdebate_selectlogoActionPerformed
// TODO add your handling code here:
        String logoPath = "";
        logoPath = BungeniEditorProperties.getEditorProperty("logoPath");
        log.debug("logo path = " + logoPath);
        String strPath = DefaultInstanceFactory.DEFAULT_INSTALLATION_PATH();
        logoPath = strPath + File.separator + logoPath;
        log.debug("logo path new = "+ logoPath);
        JFileChooser chooser = new JFileChooser();
        File fLogoPath = new File(logoPath);
        chooser.setCurrentDirectory(fLogoPath);
        int nReturnVal = chooser.showOpenDialog(this);
        if (nReturnVal == JFileChooser.APPROVE_OPTION) {
            File file = chooser.getSelectedFile();
            m_strLogoFileName = file.getName();
            m_strLogoPath = file.getAbsolutePath();
            lbl_initdebate_setpath.setText(m_strLogoFileName);
            //This is where a real application would open the file.
            log.debug("Opening: " + file.getName() + "." + "\n");
        } else {
            log.debug("Open command cancelled by user." + "\n");
        }
    }//GEN-LAST:event_btn_initdebate_selectlogoActionPerformed

    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
// TODO add your handling code here:
        parent.dispose();
    }//GEN-LAST:event_btnCancelActionPerformed

    public void setDialogMode(SelectorDialogModes mode) {
        
    }

    public SelectorDialogModes getDialogMode() {
        return theMode;
    }

    public void setOOComponentHelper(OOComponentHelper ooComp) {
    }

    public void setToolbarAction(toolbarAction action) {
    }

    public void setParentDialog(JDialog dlg) {
    }
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnApply;
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btn_initdebate_selectlogo;
    private org.jdesktop.swingx.JXDatePicker initdebate_debatedate;
    private javax.swing.JFormattedTextField initdebate_timeofhansard;
    private javax.swing.JLabel lbl_initdate_mastheadlogo;
    private javax.swing.JLabel lbl_initdebate_hansarddate;
    private javax.swing.JLabel lbl_initdebate_hansardtime;
    private javax.swing.JLabel lbl_initdebate_setpath;
    // End of variables declaration//GEN-END:variables
    
}
