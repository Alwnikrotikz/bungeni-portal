Question workflow
=================

  >>> from bungeni.core.domain import Question

Setup
-----

  >>> import bungeni.core.workflows.question
  >>> import bungeni.core.interfaces
  >>> import ore.workflow
  
  >>> component.provideAdapter(
  ...    bungeni.core.workflows.WorkflowState,
  ...    (bungeni.core.interfaces.IBungeniContent,))

  >>> component.provideAdapter(
  ...    bungeni.core.workflows.question.QuestionWorkflowAdapter,
  ...    (Question,))

  >>> component.provideAdapter(
  ...    ore.workflow.workflow.WorkflowInfo,
  ...    (Question,))

  >>> component.provideHandler(
  ...    bungeni.core.workflows.question.workflowTransitionEventDispatcher)

  >>> import bungeni.core.version
  >>> component.provideAdapter(
  ...    bungeni.core.version.ContextVersioned,
  ...    (bungeni.core.interfaces.IVersionable,),
  ...    bungeni.core.interfaces.IVersioned)
  
Transition events
-----------------

We set up event subscribers to make sure all registered transition
events are called.

  >>> map = bungeni.core.workflows.question.workflow_transition_event_map
  >>> check_transition_events = dict((states, False) for states in map.keys())

  >>> for states, iface in map.items():
  ...     def generate(key):
  ...         def handler(event):
  ...             check_transition_events[key] = True
  ...         return handler
  ...     component.provideHandler(generate(states), adapts=(iface,))
  
Workflow
--------

  >>> from ore.workflow.interfaces import IWorkflow, IWorkflowInfo

  >>> def transitions(question):
  ...     wf = IWorkflow(question)
  ...     info = IWorkflowInfo(question)
  ...     state = info.state().getState()
  ...     return tuple(transition.transition_id for transition in wf.getTransitions(state))

    >>> question = Question()

First we initialize the workflow.
  
  >>> transitions(question)
  ('create',)

  >>> IWorkflowInfo(question).fireTransition('create')

The question is now in a draft state.

  >>> transitions(question)
  ('submit-to-clerk',)

When we submit the question, a new version is created.
  
  >>> result = IWorkflowInfo(question).fireTransition('submit-to-clerk')

The transition action returns None, indicating that the the current
instance is still active.

  >>> result is None
  True

Verify that a new version was issued.

  >>> from bungeni.core.interfaces import IVersioned
  >>> versions = IVersioned(question)
  >>> len(list(versions.values()))
  1

Let's examine the version.

  >>> version = list(versions.values())[0]
  >>> version.status
  u'draft'

Submitted:

  >>> transitions(question)
  ('received-by-clerk',)

  >>> IWorkflowInfo(question).fireTransition('received-by-clerk')

Received:

  >>> transitions(question)
  ()

Transition events check
-----------------------

  >>> print check_transition_events
  {(u'submitted', u'received'): True,
   (u'draft', u'submitted'): True}
